---
title: "Digital soil mapping for precision agriculture"
subtitle: "FEAGRI-UNICAMP Workshop"
author: "Alessandro Samuel-Rosa"
date: "25 January 2019"
output: bookdown::html_document2
lang: pt
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(magrittr)
library(sf)
library(raster)

mapviewRaster <-
  function (x, ...) {
    mapview::mapview(x, alpha.regions = 0.6, map.types = "Esri.WorldImagery", ...)
  }
```

# Material and Methods

# Study area

```{r}
study_area <- sf::read_sf("../data/vector/farm.shp")
study_area$id <- 1
mapview::mapview(study_area, color = "red", alpha.regions = 0.01, map.types = "Esri.WorldImagery")
```

## Soil data

```{r, message=FALSE, warning=FALSE}
# Download data
locale <- readr::locale(decimal_mark = ",")
camada <- 
  "1VqP_W9rS4DJN3EwrGnkT_gFduMTwaupFgct-9OqK9WI" %>% 
  googlesheets::gs_key() %>% 
  googlesheets::gs_read_csv(ws = "camada", locale = locale, comment = "#metadado>", verbose = FALSE)
observacao <-
  "1VqP_W9rS4DJN3EwrGnkT_gFduMTwaupFgct-9OqK9WI" %>% 
  googlesheets::gs_key() %>% 
  googlesheets::gs_read_csv(ws = "observacao", locale = locale, comment = "#metadado>", verbose = FALSE)
soil_data <- 
  merge(observacao, camada, by = "observacao_id") %>% 
  sf::st_as_sf(coords = c("coord_x", "coord_y"), crs = 32722) %T>% 
  print()
```

```{r}
study_area %>% 
  mapview::mapview(map.types = "Esri.WorldImagery", color = "red", alpha.regions = 0.01, legend = FALSE) +
  dplyr::select(soil_data, observacao_id) %>% mapview::mapview(homebutton = FALSE, layer.name = "ID")
```

## Covariates

First try to load all rasters and stack them.
They have different number of rows and/or columns due to different resolution. Thus, it is not gonna work.
So we, first have process them.

```{r}
covars <- 
  c("ndvi_2013_04_22.tif", "ndvi_2016_01_25.tif", "ndvi_2018_04_20.tif", "dem.tif", "ec.tif") %>% 
  paste("../data/raster/", ., sep = "")
covar_data <- raster::stack(covars)
```

Verify resolution of all raster. The DEM has a different resolution. So, we have to process it.

```{r}
sapply(covars, function (x) raster::raster(x) %>% c(res(.), dim(.)))
```

Because the DEM is the largest raster, we resample the other rasters to match the DEM resolution and dimension.
But first we set its resolution to 30 m x 30 m.

```{r}
sf::gdal_utils(
  "warp", source = covars[4], destination = "../data/raster/dem_30m.tif", processing = "-tr 30 30 -r cubic")
covars[4] <- "../data/raster/dem_30m.tif"
covar_data <- raster::raster(covars[4])
covar_data <-
  raster::stack(covars[-4]) %>% 
  raster::resample(y = covar_data) %>% 
  raster::stack(covar_data) %T>% 
  print()
```

See the spatial distribution of the data.

```{r}
mapviewRaster(covar_data) +
  mapview::mapview(study_area, legend = FALSE, alpha.regions = 0.01, color = "red", homebutton = FALSE)
```

### Terrain attibutes

Compute some usefull terrain attibutes using RSAGA. Note the SAGA grid format (SDAT and SGRD).

```{r}
env <- RSAGA::rsaga.env()
RSAGA::rsaga.slope.asp.curv(
  in.dem = "../data/raster/dem_30m.tif",
  out.slope = "../data/raster/slope.sgrd",
  out.cgene = "../data/raster/general_curvature.sgrd",
  out.cplan = "../data/raster/plan_curvature.sgrd",
  out.cprof = "../data/raster/profile_curvature.sgrd",
  unit.slope = "percent")
RSAGA::rsaga.wetness.index(
  in.dem = "../data/raster/dem_30m.tif",
  out.wetness.index = "../data/raster/twi.sgrd", 
  out.carea = "../data/raster/catch_area.sgrd", 
  out.cslope = "../data/raster/catch_slope.sgrd", 
  area.type = "absolute")
```

```{r}
covar_data <-
  raster::stack(
    c("../data/raster/slope.sdat",
    "../data/raster/general_curvature.sdat",
    "../data/raster/plan_curvature.sdat", 
    "../data/raster/profile_curvature.sdat",
    "../data/raster/twi.sdat", 
    "../data/raster/catch_area.sdat",
    "../data/raster/catch_slope.sdat")) %>% 
  raster::stack(covar_data)
covar_data[["catch_area"]] <- log(covar_data[["catch_area"]])
covar_data
```

```{r}
mapviewRaster(covar_data[[1:7]]) +
  mapview::mapview(study_area, legend = FALSE, alpha.regions = 0.01, color = "red", homebutton = FALSE)
```

Create a terrain attribute to depict the upslope distance from source cells.

```{r}
if (file.exists("../data/vector/seeds.shp")) {
  seeds <- sf::read_sf("../data/vector/seeds.shp")
  mapview::mapview(seeds["id"], map.types = "Esri.WorldImagery")
} else {
  seeds <- 
    mapview::mapview(study_area, alpha.regions = 0.01, color = "red", map.types = "Esri.WorldImagery") %>% 
    mapedit::drawFeatures() %>% 
    sf::st_transform(crs = 32722)
  seeds$id <- 1
  sf::write_sf(seeds, "../data/vector/seeds.shp")
  mapview::mapview(seeds["id"], map.types = "Esri.WorldImagery")
}
```

```{r}
# Shapes to Grid
# RSAGA::rsaga.get.libraries()
# RSAGA::rsaga.get.lib.modules("grid_gridding")
RSAGA::rsaga.geoprocessor(lib = "grid_gridding", module = 0, param = list(
  INPUT = "../data/vector/seeds.shp",
  TARGET_DEFINITION = 1,
  TARGET_TEMPLATE = "../data/raster/slope.sgrd",
  GRID = "../data/raster/seeds_grid.sgrd"))
# Flow Path Length (Deterministic 8)
# RSAGA::rsaga.get.libraries()
# RSAGA::rsaga.get.lib.modules("ta_hydrology")
RSAGA::rsaga.geoprocessor(lib = "ta_hydrology", module = 6, param = list(
  ELEVATION = "../data/raster/dem_30m.tif",
  SEED = "../data/raster/seeds_grid.sgrd",
  LENGTH = "../data/raster/flow_path_length.sgrd",
  SEEDS_ONLY = 1,
  METHOD = 0
))
flow_length <- raster::raster("../data/raster/flow_path_length.sdat")
raster::crs(flow_length) <- sf::st_crs(covar_data)$proj4string
mapview::mapview(study_area, map.types = "Esri.WorldImagery", color = "red", alpha.region = 0.01) +
  mapview::mapview(flow_length) +
  mapview::mapview(seeds)
```

```{r}
# Proximity Grid
# RSAGA::rsaga.get.libraries()
# RSAGA::rsaga.get.lib.modules("grid_tools")
RSAGA::rsaga.geoprocessor(lib = "grid_tools", module = 26, param = list(
  FEATURES = "../data/raster/seeds_grid.sgrd",
  DISTANCE = "../data/raster/seeds_distance.sgrd"
))
seeds_dist <- raster::raster("../data/raster/seeds_distance.sdat")
mapview::mapview(study_area, map.types = "Esri.WorldImagery", color = "red", alpha.region = 0.01) +
  mapview::mapview(seeds_dist) +
  mapview::mapview(seeds)
```

```{r}
flow_length[] <- flow_length[] / max(flow_length[], na.rm = TRUE)
flow_length[][is.na(flow_length[])] <- 1
seeds_dist_plus <- seeds_dist * flow_length
names(seeds_dist_plus) <- "seeds_dist_plus"
mapview::mapview(study_area, map.types = "Esri.WorldImagery", color = "red", alpha.region = 0.01) +
  mapview::mapview(seeds_dist_plus, col.regions = terrain.colors(800) %>% rev(), alpha.region = 1) +
  mapview::mapview(seeds)
```

```{r}
covar_data %<>%  raster::stack(seeds_dist_plus)
```

The correlation between covariates.

```{r}
covar_data[] %>% 
  cor(use = "complete") %>% 
  round(2) %>% 
  pedometrics::plotCor()
```

### Other covariares

```{r}
fields <- 
  sf::read_sf("../data/vector/fields.shp") %>% 
  sf::st_transform(crs = 32722)
fields$id <- 1:nrow(fields)
mapview::mapview(fields, map.types = "Esri.WorldImagery", legend = FALSE) +
  mapview::mapview(soil_data["observacao_id"], legend = FALSE) +
  mapview::mapview(study_area, legend = FALSE, alpha.regions = 0.01, color = "red", homebutton = FALSE)
```

## Modelling

Sample covariates at the location of sampling points.

```{r}
soil_data %<>% cbind(., raster::extract(covar_data, .))
soil_data$fields <- raster::extract(sf::as_Spatial(fields), sf::as_Spatial(soil_data))[, "id"]
```

```{r}
f <- fosforo_resina ~ slope + general_curvature + plan_curvature + profile_curvature + twi + catch_area + catch_slope + ndvi_2013_04_22 + ndvi_2016_01_25 + ndvi_2018_04_20 + ec + dem_30m + camada_id + seeds_dist_plus

fit <- 
  soil_data %>% 
  caret::train(
    f, data = ., na.action = na.omit,
    method = "ranger", tuneGrid = data.frame(mtry = 4, splitrule = "variance", min.node.size = 5),
    trControl = caret::trainControl(method = "LOOCV")) %T>%
  print()
  caret::getModelInfo("rf")
```

```{r}
soil_data %>% 
  dplyr::select(areia_xxx_xxx_xxx) %>% 
  dplyr::filter(areia_xxx_xxx_xxx > 890) %>%
  mapview::mapview(map.types = "Esri.WorldImagery") + 
  mapview::mapview(study_area, legend = FALSE, alpha.regions = 0.01, color = "red", homebutton = FALSE)
```



```{r}
covar_data$camada_id <- 1
soil_data$fosforo_resina_log <- log1p(soil_data$fosforo_resina)
predictions <- raster::predict(covar_data, fit)
mapviewRaster(predictions) + 
  mapview::mapview(soil_data[soil_data$camada_id == 1, "fosforo_resina"], legend = FALSE)
```

